#include "VoxIO.h"
#include "Array3D.h"
#include "Vec2.h"
#include "BBox.h"

#include <fstream>
#include <sstream>
#include <iostream>

std::vector<Vec2f> LoadVec2Arr(const std::string& filename) {
  std::ifstream in(filename);
  std::string line;
  std::vector<Vec2f> vec;
  while (std::getline(in, line)) {
    if (line.size() < 3) {
      continue;
    }
    std::istringstream iss(line);
    Vec2f v;
    iss >> v[0] >> v[1];
    vec.push_back(v);
  }
  return vec;
}

float Linterp(const std::vector<Vec2f>& arr, float x) {
  if (arr.size() == 0) {
    return 0;
  }
  if (x <= 0) {
    return 0;
  }
  if (x <= arr[0][0]) {
    return x / arr[0][0] * arr[0][1];
  }
  auto it =
      std::lower_bound(arr.begin(), arr.end(), x,
                       [](const Vec2f& a, float val) { return a[0] < val; });
  if (it == arr.end()) {
    return arr.back()[1];
  }
  size_t i = std::distance(arr.begin(), it);
  float alpha = (arr[i][0] - x) / (arr[i][0] - arr[i - 1][0]);
  float val = alpha * arr[i - 1][1] + (1 - alpha) * arr[i][1];
  return val;
}

float RhoToEps(float rho) {
  const float EpsSolid = 2.35;
  float eps = (2.7*rho+4.35) / (4.35-1.35*rho);
  return eps;
}

struct LookupTable {
  std::vector<float> y;
  float x0 = 0;
  float dx = 0.01;
  float Lookup(float x) {
    int i0 = int((x - x0) / dx);
    if (i0 <= 0) {
      return y[0];
    }
    if (i0 >= y.size() - 1) {
      return y[y.size() - 1];
    }
    float alpha1 = (x - (x0 + dx * i0))/dx;
    float alpha = 1 - alpha1;
    float interp = alpha * y[i0] + alpha1*y[i0+1];
    return interp;
  }
};

LookupTable InverseIncreasingMap(const std::vector<Vec2f>& a, float dx) {
  LookupTable lut;
  lut.dx = dx;
  lut.x0 = a[0][1];
  float xmax = a.back()[1];
  size_t numx = (xmax - lut.x0) / dx;
  lut.y.resize(numx);

  std::vector<Vec2f> invCopy(a.size());
  for (size_t i = 0; i < a.size(); i++) {
    invCopy[i][0] = a[i][1];
    invCopy[i][1] = a[i][0];
  }

  for (size_t i = 0; i < numx; i++) {
    float x = lut.x0 + i * lut.dx;
    float y = Linterp(invCopy, x);
    lut.y[i] = y;
  }
  return lut;
}

struct PointSample {
  Vec3f pos;
  float val = 0;  
};

const float Gyroid5mm[] = {
    0,       0.02762, 0.03766, 0.04215, 0.04665, 0.05051, 0.05251, 0.05451,
    0.0565,  0.0585,  0.0605,  0.0625,  0.06344, 0.06439, 0.06533, 0.06627,
    0.06722, 0.06816, 0.06911, 0.07005, 0.07099, 0.07194, 0.07288, 0.07383,
    0.07477, 0.07567, 0.07657, 0.07746, 0.07835, 0.07924, 0.08013, 0.08102,
    0.08191, 0.0828,  0.0837,  0.08459, 0.08548, 0.08637, 0.08726, 0.08845,
    0.08976, 0.09106, 0.09237, 0.09367, 0.09497, 0.09628, 0.09758, 0.09889,
    0.1002,  0.1017,  0.1033,  0.1048,  0.1063,  0.1078,  0.1093,  0.1109,
    0.1124,  0.114,   0.1156,  0.1172,  0.1188,  0.1205,  0.1221,  0.1237,
    0.1253,  0.127,   0.1287,  0.1304,  0.1321,  0.1338,  0.1355,  0.1371,
    0.1389,  0.1408,  0.1426,  0.1444,  0.1462,  0.148,   0.1498,  0.1517,
    0.1535,  0.1553,  0.1571,  0.159,   0.1608,  0.1626,  0.1645,  0.1663,
    0.1682,  0.17,    0.1719,  0.1737,  0.1756,  0.1775,  0.1794,  0.1813,
    0.1832,  0.1851,  0.187,   0.1889,  0.1909,  0.1928,  0.1947,  0.1967,
    0.1986,  0.2005,  0.2024,  0.2043,  0.2062,  0.208,   0.2099,  0.2118,
    0.2137,  0.2155,  0.2173,  0.2192,  0.221,   0.2228,  0.2247,  0.2266,
    0.2285,  0.2304,  0.2324,  0.2343,  0.2362,  0.2382,  0.2401,  0.2421,
    0.2441,  0.246,   0.248,   0.25,    0.2518,  0.2537,  0.2556,  0.2575,
    0.2594,  0.2613,  0.2632,  0.2651,  0.2669,  0.2688,  0.2706,  0.2725,
    0.2743,  0.2762,  0.2781,  0.28,    0.2819,  0.2838,  0.2856,  0.2875,
    0.2895,  0.2914,  0.2934,  0.2953,  0.2973,  0.2992,  0.3012,  0.3031,
    0.305,   0.3068,  0.3087,  0.3106,  0.3125,  0.3144,  0.3163,  0.3182,
    0.3201,  0.3219,  0.3238,  0.3257,  0.3276,  0.3295,  0.3314,  0.3333,
    0.3352,  0.3372,  0.3391,  0.341,   0.3429,  0.3449,  0.3468,  0.3487,
    0.3506,  0.3525,  0.3543,  0.3562,  0.358,   0.3599,  0.3617,  0.3636,
    0.3654,  0.3673,  0.3692,  0.371,   0.3729,  0.3747,  0.3767,  0.3786,
    0.3806,  0.3825,  0.3845,  0.3865,  0.3884,  0.3904,  0.3923,  0.3943,
    0.3962,  0.3982,  0.4001,  0.402,   0.4038,  0.4057,  0.4075,  0.4093,
    0.4112,  0.413,   0.4148,  0.4167,  0.4185,  0.4203,  0.4222,  0.424,
    0.4258,  0.4278,  0.4297,  0.4316,  0.4336,  0.4355,  0.4374,  0.4394,
    0.4414,  0.4434,  0.4453,  0.4473,  0.4493,  0.4512,  0.453,   0.4549,
    0.4568,  0.4586,  0.4605,  0.4623,  0.4642,  0.466,   0.4678,  0.4697,
    0.4715,  0.4733,  0.4752,  0.4771,  0.4791,  0.481,   0.4829,  0.4848,
    0.4868,  0.4887,  0.4906,  0.4925,  0.4944,  0.4963,  0.4982,  0.5001,
    0.502,   0.5038,  0.5057,  0.5075,  0.5094,  0.5112,  0.5131,  0.5149,
    0.5168,  0.5187,  0.5206,  0.5224,  0.5243,  0.5262,  0.5282,  0.5301,
    0.5321,  0.534,   0.536,   0.5379,  0.5398,  0.5416,  0.5435,  0.5454,
    0.5473,  0.5491,  0.551,   0.5528,  0.5546,  0.5564,  0.5583,  0.5601,
    0.5619,  0.5638,  0.5656,  0.5675,  0.5694,  0.5713,  0.5732,  0.5751,
    0.577,   0.579,   0.5809,  0.5829,  0.5848,  0.5868,  0.5887,  0.5906,
    0.5925,  0.5944,  0.5963,  0.5982,  0.6001,  0.6019,  0.6037,  0.6055,
    0.6073,  0.6091,  0.6109,  0.6127,  0.6146,  0.6165,  0.6183,  0.6202,
    0.622,   0.6239,  0.6258,  0.6277,  0.6297,  0.6316,  0.6336,  0.6355,
    0.6375,  0.6393,  0.6412,  0.643,   0.6449,  0.6467,  0.6486,  0.6504,
    0.6523,  0.6541,  0.656,   0.6578,  0.6597,  0.6615,  0.6634,  0.6653,
    0.6672,  0.6691,  0.671,   0.6729,  0.6748,  0.6767,  0.6786,  0.6805,
    0.6823,  0.6842,  0.6861,  0.6879,  0.6897,  0.6915,  0.6934,  0.6952,
    0.697,   0.6988,  0.7006,  0.7025,  0.7044,  0.7062,  0.7081,  0.71,
    0.7119,  0.7138,  0.7158,  0.7177,  0.7197,  0.7216,  0.7235,  0.7255,
    0.7273,  0.7291,  0.731,   0.7328,  0.7347,  0.7365,  0.7383,  0.7401,
    0.7419,  0.7437,  0.7454,  0.7472,  0.749,   0.7508,  0.7527,  0.7546,
    0.7565,  0.7584,  0.7603,  0.7622,  0.7641,  0.766,   0.7679,  0.7698,
    0.7718,  0.7737,  0.7756,  0.7774,  0.7792,  0.781,   0.7828,  0.7847,
    0.7865,  0.7883,  0.7902,  0.792,   0.7939,  0.7957,  0.7976,  0.7994,
    0.8013,  0.8032,  0.8051,  0.8069,  0.8088,  0.8107,  0.8126,  0.8144,
    0.8162,  0.818,   0.8199,  0.8217,  0.8235,  0.8253,  0.8271,  0.829,
    0.8308,  0.8326,  0.8345,  0.8363,  0.8382,  0.8401,  0.842,   0.8439,
    0.8458,  0.8477,  0.8496,  0.8515,  0.8533,  0.8552,  0.857,   0.8589,
    0.8607,  0.8625,  0.8643,  0.8661,  0.8679,  0.8696,  0.8714,  0.8732,
    0.875,   0.8768,  0.8787,  0.8805,  0.8824,  0.8843,  0.8861,  0.888,
    0.8899,  0.8918,  0.8937,  0.8957,  0.8976,  0.8995,  0.9013,  0.9031,
    0.9049,  0.9067,  0.9086,  0.9104,  0.9122,  0.914,   0.9157,  0.9175,
    0.9193,  0.9211,  0.9229,  0.9247,  0.9266,  0.9285,  0.9303,  0.9322,
    0.9341,  0.936,   0.9378,  0.9397,  0.9415,  0.9433,  0.9451,  0.9469,
    0.9487,  0.9506,  0.9524,  0.9542,  0.956,   0.9578,  0.9596,  0.9614,
    0.9632,  0.9651,  0.967,   0.9688,  0.9707,  0.9726,  0.9744,  0.9763,
    0.9781,  0.9799,  0.9817,  0.9836,  0.9854,  0.9872,  0.989,   0.9907,
    0.9925,  0.9942,  0.996,   0.9977,  0.9995,  1.001,   1.003,   1.005,
    1.007,   1.009,   1.011,   1.012,   1.014,   1.016,   1.018,   1.02,
    1.022,   1.024,   1.026,   1.027,   1.029,   1.031,   1.033,   1.034,
    1.036,   1.038,   1.04,    1.041,   1.043,   1.045,   1.047,   1.049,
    1.05,    1.052,   1.054,   1.056,   1.058,   1.06,    1.062,   1.063,
    1.065,   1.067,   1.069,   1.071,   1.072,   1.074,   1.076,   1.078,
    1.08,    1.081,   1.083,   1.085,   1.087,   1.089,   1.09,    1.092,
    1.094,   1.096,   1.098,   1.099,   1.101,   1.103,   1.105,   1.107,
    1.108,   1.11,    1.112,   1.114,   1.115,   1.117,   1.119,   1.121,
    1.123,   1.124,   1.126,   1.128,   1.13,    1.132,   1.134,   1.135,
    1.137,   1.139,   1.141,   1.143,   1.144,   1.146,   1.148,   1.15,
    1.151,   1.153,   1.155,   1.157,   1.158,   1.16,    1.162,   1.164,
    1.166,   1.167,   1.169,   1.171,   1.173,   1.175,   1.176,   1.178,
    1.18,    1.182,   1.184,   1.185,   1.187,   1.189,   1.191,   1.193,
    1.194,   1.196,   1.198,   1.2,     1.201,   1.203,   1.205,   1.207,
    1.208,   1.21,    1.212,   1.214,   1.215,   1.217,   1.219,   1.221,
    1.223,   1.224,   1.226,   1.228,   1.23,    1.232,   1.233,   1.235,
    1.237,   1.239,   1.24,    1.242,   1.244,   1.246,   1.247,   1.249,
    1.251,   1.253,   1.254,   1.256,   1.258,   1.26,    1.262,   1.263,
    1.265,   1.267,   1.268,   1.27,    1.272,   1.274,   1.275,   1.277,
    1.279,   1.281,   1.283,   1.284,   1.286,   1.288,   1.29,    1.291,
    1.293,   1.295,   1.297,   1.298,   1.3,     1.302,   1.304,   1.305,
    1.307,   1.309,   1.31,    1.312,   1.314,   1.316,   1.317,   1.319,
    1.321,   1.323,   1.325,   1.326,   1.328,   1.33,    1.332,   1.333,
    1.335,   1.337,   1.339,   1.34,    1.342,   1.344,   1.345,   1.347,
    1.349,   1.35,    1.352,   1.354,   1.356,   1.357,   1.359,   1.361,
    1.363,   1.364,   1.366,   1.368,   1.369,   1.371,   1.373,   1.375,
    1.376,   1.378,   1.38,    1.381,   1.383,   1.385,   1.387,   1.388,
    1.39,    1.392,   1.393,   1.395,   1.397,   1.398,   1.4,     1.402,
    1.404,   1.405,   1.407,   1.409,   1.411,   1.412,   1.414,   1.416,
    1.417,   1.419,   1.421,   1.423,   1.424,   1.426,   1.428,   1.429,
    1.431,   1.433,   1.434,   1.436,   1.438,   1.439,   1.441,   1.443,
    1.444,   1.446,   1.448,   1.449,   1.451,   1.453,   1.455,   1.456,
    1.458,   1.46,    1.461,   1.463,   1.465,   1.466,   1.468,   1.47,
    1.471,   1.473,   1.475,   1.476,   1.478,   1.48,    1.481,   1.483,
    1.485,   1.487,   1.488,   1.49,    1.492,   1.493,   1.495,   1.497,
    1.498,   1.5,     1.501,   1.503,   1.505,   1.506,   1.508,   1.51,
    1.511,   1.513,   1.515,   1.516,   1.518,   1.52,    1.521,   1.523,
    1.525,   1.526,   1.528,   1.53,    1.531,   1.533,   1.535,   1.536,
    1.538,   1.54,    1.541,   1.543,   1.545,   1.546,   1.548,   1.549,
    1.551,   1.553,   1.554,   1.556,   1.558,   1.559,   1.561,   1.563,
    1.564,   1.566,   1.567,   1.569,   1.571,   1.572,   1.574,   1.575,
    1.577,   1.579,   1.58,    1.582,   1.584,   1.585,   1.587,   1.588,
    1.59,    1.592,   1.593,   1.595,   1.597,   1.598,   1.6,     1.601,
    1.603,   1.605,   1.606,   1.608,   1.609,   1.611,   1.613,   1.614,
    1.616,   1.617,   1.619,   1.621,   1.622,   1.624,   1.625,   1.627,
    1.629,   1.63,    1.632,   1.633,   1.635,   1.637,   1.638,   1.64,
    1.641,   1.643,   1.644,   1.646,   1.648,   1.649,   1.651,   1.652,
    1.654,   1.655,   1.657,   1.659,   1.66,    1.662,   1.663,   1.665,
    1.666,   1.668,   1.67,    1.671,   1.673,   1.674,   1.676,   1.677,
    1.679,   1.68,    1.682,   1.684,   1.685,   1.687,   1.688,   1.69,
    1.691,   1.693,   1.694,   1.696,   1.698,   1.699,   1.701,   1.702,
    1.704,   1.705,   1.707,   1.708,   1.71,    1.711,   1.713,   1.714,
    1.716,   1.717,   1.719,   1.72,    1.722,   1.723,   1.725,   1.726,
    1.728,   1.729,   1.731,   1.732,   1.734,   1.735,   1.737,   1.739,
    1.74,    1.742,   1.744,   1.746,   1.748,   1.749,   1.751,   1.753,
    1.756,   1.758,   1.76,    1.762,   1.764,   1.767,   1.769,   1.772,
    1.774,   1.777,   1.78,    1.783,   1.786,   1.789,   1.792,   1.795,
    1.799,   1.802,   1.806,   1.81,    1.815,   1.82,    1.825,   1.833,
    1.85};


void TestGrin() { 
  std::vector<Vec2f> rhoToE(98);
  std::cout << sizeof(Gyroid5mm) << "\n";
  std::vector<float> gyroid5mmR2T(sizeof(Gyroid5mm) / sizeof(Gyroid5mm[0]));
  for (size_t i = 0; i < gyroid5mmR2T.size(); i++) {
    gyroid5mmR2T[i] = Gyroid5mm[i];
  }
  LookupTable r2t;
  r2t.y = gyroid5mmR2T;
  r2t.dx = 0.001;
  r2t.x0 = 0;  
  float rho0 = 0.01;
  float drho = 0.01;
  for (size_t i = 0; i < rhoToE.size();i++) {
    float rho = rho0 + i * drho;
    float eps = RhoToEps(rho);
    rhoToE[i] = Vec2f(rho, eps);
  }

  LookupTable lut = InverseIncreasingMap(rhoToE, 0.01);
  //out.open("F:/meshes/grin_lens/e2r.txt");
  //for (size_t i = 0; i < lut.y.size() * 3; i++) {
  //  float x = (lut.x0 + i * lut.dx/3);
  //  float y = lut.Lookup(x);
  //  out << x << " " << y << "\n";    
  //}
  //out.close();
  std::vector<PointSample> points;
  std::ifstream in("F:/meshes/grin_lens/Lens_Permittivity.txt");
  std::string line;
  while (std::getline(in, line)) {
    if (line.size() < 4) {
      continue;
    }
    std::istringstream iss(line);
    PointSample ps;
    iss >> ps.pos[0] >> ps.pos[1] >> ps.pos[2] >> ps.val;

    //scale from cm to mm.
    ps.pos *= 10;
    points.push_back(ps);
  }
  in.close();

  float dx = 1;
  float dy = 1;
  float dz = 8 / 29.0f;
  Box3f box;
  box.vmin = points[0].pos;
  box.vmax = points[0].pos;

  for (size_t i = 1; i < points.size(); i++) {
    for (unsigned dim = 0; dim < 3; dim++) {
      box.vmin[dim] = std::min(box.vmin[dim], points[i].pos[dim]);
      box.vmax[dim] = std::max(box.vmax[dim], points[i].pos[dim]);
    }
  }
  std::cout << box.vmin[0] << " " << box.vmin[1] << " " << box.vmin[2] << "\n";
  std::cout << box.vmax[0] << " " << box.vmax[1] << " " << box.vmax[2] << "\n";
  Vec3u gridSize;
  Vec3f boxSize = box.vmax - box.vmin;
  gridSize[0] = std::roundf(boxSize[0] / dx) + 1;
  gridSize[1] = std::roundf(boxSize[1] / dy) + 1;
  gridSize[2] = std::roundf(boxSize[2] / dz) + 1;
  std::cout << gridSize[0] << " " << gridSize[1] << " " << gridSize[2] << "\n";
  
  Array3Df field(gridSize, 0);
  for (size_t i = 0; i < points.size(); i++) {
    Vec3f p = points[i].pos - box.vmin;
    unsigned ix = std::roundf(p[0] / dx);
    unsigned iy = std::roundf(p[1] / dy);
    unsigned iz = std::roundf(p[2] / dz);
    float rho = lut.Lookup(points[i].val);
    float t = r2t.Lookup(rho);
    field(ix, iy, iz) = t;
  }
  Vec3f res(dx, dy, dz);
  SaveVoxTxt(field, res, "F:/meshes/grin_lens/t_field.txt", box.vmin);
}
